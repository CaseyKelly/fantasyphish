// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  username           String    @unique @default("")
  passwordHash       String
  emailVerified      DateTime?
  verificationToken  String?   @unique
  verificationExpiry DateTime?
  isAdmin            Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  submissions        Submission[]
  achievements       UserAchievement[]
}

model Tour {
  id        String    @id @default(cuid())
  name      String    // e.g., "Summer Tour 2024"
  startDate DateTime
  endDate   DateTime?
  shows     Show[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Show {
  id              String       @id @default(cuid())
  showDate        DateTime     @unique
  venue           String
  city            String?
  state           String?
  country         String?
  tourId          String?
  tour            Tour?        @relation(fields: [tourId], references: [id])
  setlistJson     Json?        // Cached setlist from phish.net
  isComplete      Boolean      @default(false)
  fetchedAt       DateTime?
  timezone        String?      // Venue timezone (e.g., "America/New_York")
  lockTime        DateTime?    // Time when picks locked (7 PM in venue timezone)
  lastScoredAt    DateTime?    // Last progressive scoring run
  encoreStartedAt DateTime?    // When encore was first detected (for 1-hour grace period)
  submissions     Submission[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([showDate])
  @@index([tourId])
}

model Submission {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  showId        String
  show          Show     @relation(fields: [showId], references: [id], onDelete: Cascade)
  isScored      Boolean  @default(false)
  totalPoints   Int?
  lastSongCount Int?     // Track song count for progressive scoring
  picks         Pick[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, showId]) // One submission per user per show
  @@index([userId])
  @@index([showId])
}

enum PickType {
  OPENER
  ENCORE
  REGULAR
}

model Pick {
  id           String     @id @default(cuid())
  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  songId       String
  song         Song       @relation(fields: [songId], references: [id])
  pickType     PickType
  wasPlayed    Boolean?
  pointsEarned Int?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([submissionId])
  @@index([songId])
}

model Song {
  id                 String    @id @default(cuid())
  name               String
  slug               String    @unique // For matching with phish.net
  artist             String    @default("Phish") // Some covers have different artists
  timesPlayed        Int       @default(0)
  recentTimesPlayed  Int       @default(0) // Times played in last 5 years
  gap                Int?      // Shows since last played
  lastPlayed         DateTime? // Date last played
  picks              Pick[]
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([name])
  @@index([slug])
}

model Achievement {
  id               String            @id @default(cuid())
  slug             String            @unique // e.g., "nye-run-2025-participant"
  name             String            // e.g., "NYE Run 2025 Participant"
  description      String            // e.g., "Made picks for Phish's NYE Run 2025"
  icon             String            // emoji or icon identifier
  category         AchievementCategory
  metadata         Json?             // flexible field for tour names, dates, rankings, etc.
  createdAt        DateTime          @default(now())
  userAchievements UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  earnedAt      DateTime    @default(now())
  metadata      Json?       // for achievement-specific data (e.g., final rank, points)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

enum AchievementCategory {
  PARTICIPATION // Participated in a tour/event
  RANKING       // Placed in leaderboard (1st, 2nd, 3rd)
  MILESTONE     // Hit a milestone (10 shows, 100 points, etc.)
  SPECIAL       // Special events or rare achievements
}
